# Удалена строка version: '3.8' - она устарела

services:
  # ==================== PostgreSQL (единый экземпляр) ====================
  postgresql:
    image: postgres:14.15-alpine3.21
    container_name: postgresql
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
      # Переменные для скрипта инициализации баз данных
      MAYAN_DATABASE_PASSWORD: ${MAYAN_DATABASE_PASSWORD}
      CAMUNDA_DATABASE_PASSWORD: ${CAMUNDA_DATABASE_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./data/postgresql:/var/lib/postgresql/data
      - ./scripts/postgresql-init:/docker-entrypoint-initdb.d
      - ./backups/postgresql:/backups
    networks:
      - services_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - "postgres"
      - "-c"
      - "default_statistics_target=200"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "work_mem=32MB"

  # ==================== PostgreSQL Backup Service ====================
  postgresql-backup:
    image: postgres:14.15-alpine3.21
    container_name: postgresql-backup
    environment:
      PGHOST: postgresql
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./backups/postgresql:/backups
      - ./scripts/backup-script.sh:/backup-script.sh
    networks:
      - services_network
    depends_on:
      postgresql:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/backup-script.sh"]
    profiles:
      - backup

  # ==================== OpenLDAP ====================
  openldap:
    image: osixia/openldap:latest
    container_name: openldap
    environment:
      - LDAP_ORGANISATION=${LDAP_ORGANISATION}
      - LDAP_DOMAIN=${LDAP_DOMAIN}
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ./data/openldap/ldap_data:/var/lib/ldap
      - ./data/openldap/ldap_config:/etc/ldap/slapd.d
      - ./backups/openldap:/backups
    networks:
      - services_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ldapwhoami -x -H ${LDAP_URL} -D ${LDAP_USER} -w ${LDAP_PASSWORD} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ==================== phpLDAPadmin ====================
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: phpldapadmin
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=openldap
    ports:
      - "6443:443"
    depends_on:
      - openldap
    networks:
      - services_network
    restart: unless-stopped

  # ==================== RabbitMQ (для Mayan) ====================
  rabbitmq:
    image: rabbitmq:4.0.5-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${MAYAN_RABBITMQ_USER:-mayan}
      RABBITMQ_DEFAULT_PASS: ${MAYAN_RABBITMQ_PASSWORD:-mayanrabbitpass}
      RABBITMQ_DEFAULT_VHOST: ${MAYAN_RABBITMQ_VHOST:-mayan}
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: ${MAYAN_RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS:--rabbit consumer_timeout 1800000}
    ports:
      - "${MAYAN_RABBITMQ_ADMIN_PORT:-15672}:15672"
      - "5672:5672"
    volumes:
      - ./data/rabbitmq:/var/lib/rabbitmq
      - ./backups/rabbitmq:/backups
    networks:
      - services_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ==================== Redis (для Mayan) ====================
  redis:
    image: redis:7.4.1-alpine3.20
    container_name: redis
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --databases
      - "3"
      - --maxmemory
      - "100mb"
      - --maxclients
      - "500"
      - --maxmemory-policy
      - "allkeys-lru"
      - --requirepass
      - "${MAYAN_REDIS_PASSWORD}"
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
      - ./backups/redis:/backups
    networks:
      - services_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${MAYAN_REDIS_PASSWORD} ping | grep PONG || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==================== Elasticsearch (для Mayan, опционально) ====================
  elasticsearch:
    image: elasticsearch:7.17.26
    container_name: elasticsearch
    environment:
      - bootstrap.memory_lock=true
      - discovery.type=single-node
      - http.max_content_length=400mb
      - xpack.security.enabled=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - ELASTIC_PASSWORD=${MAYAN_ELASTICSEARCH_PASSWORD}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./data/elasticsearch:/usr/share/elasticsearch/data
      - ./backups/elasticsearch:/backups
    networks:
      - services_network
    restart: unless-stopped
    profiles:
      - elasticsearch

  # ==================== Mayan EDMS ====================
  mayan-app:
    image: mayanedms/mayanedms:latest
    container_name: mayan-app
    environment:
      MAYAN_CELERY_BROKER_URL: amqp://${MAYAN_RABBITMQ_USER:-mayan}:${MAYAN_RABBITMQ_PASSWORD:-mayanrabbitpass}@rabbitmq:5672/${MAYAN_RABBITMQ_VHOST:-mayan}
      MAYAN_CELERY_RESULT_BACKEND: redis://:${MAYAN_REDIS_PASSWORD}@redis:6379/1
      MAYAN_DATABASES: "{'default':{'ENGINE':'django.db.backends.postgresql','NAME':'mayan','PASSWORD':'${MAYAN_DATABASE_PASSWORD}','USER':'${MAYAN_DATABASE_USER}','HOST':'postgresql','PORT':5432,'CONN_MAX_AGE':0}}"
      MAYAN_LOCK_MANAGER_BACKEND: mayan.apps.lock_manager.backends.redis_lock.RedisLock
      MAYAN_LOCK_MANAGER_BACKEND_ARGUMENTS: "{'redis_url':'redis://:${MAYAN_REDIS_PASSWORD}@redis:6379/2'}"
      MAYAN_SETTINGS_MODULE: user_settings.ldap_connection_settings
      LDAP_USER_AUTO_CREATION: ${LDAP_USER_AUTO_CREATION}
      LDAP_URL: ${LDAP_URL}
      LDAP_BASE_DN: ${LDAP_BASE_DN}
      LDAP_ADDITIONAL_USER_DN: ${LDAP_ADDITIONAL_USER_DN}
      LDAP_ADMIN_DN: ${LDAP_USER}
      LDAP_USER: ${LDAP_USER}
      LDAP_PASSWORD: ${LDAP_PASSWORD}
      MAYAN_DOCUMENTS_FILE_STORAGE_BACKEND: "storages.backends.s3boto3.S3Boto3Storage"
      MAYAN_DOCUMENTS_FILE_STORAGE_BACKEND_ARGUMENTS: ${MAYAN_DOCUMENTS_FILE_STORAGE_BACKEND_ARGUMENTS}
    ports:
      - "${MAYAN_FRONTEND_HTTP_PORT:-80}:8000"
    volumes:
      - ./data/mayan/app:/var/lib/mayan
      - ./mayan/document_deadlines:/var/lib/mayan/document_deadlines
      - ./mayan/media:/var/lib/mayan/user_settings
      - ./backups/mayan:/backups
    networks:
      - services_network
    depends_on:
      postgresql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      openldap:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
        mode: "non-blocking"

  # ==================== Camunda BPM ====================
  camunda:
    image: camunda/camunda-bpm-platform:run-latest
    container_name: camunda
    ports:
      - "8081:8080"
      - "8443:8443"
    command: ["./start.sh", "--production"]
    volumes:
      - ./camunda/production.yml:/camunda/configuration/production.yml
      - ./data/camunda:/camunda/webapps
      - ./backups/camunda:/backups
    environment:
      - CAMUNDA_BPM_RUN_CONFIGURATION=production
      # Переменные окружения для Spring Boot (используются в production.yml)
      - LDAP_USER=${LDAP_USER}
      - LDAP_PASSWORD=${LDAP_PASSWORD}
      - LDAP_BASE_DN=${LDAP_BASE_DN}
      - CAMUNDA_DATABASE_USER=${CAMUNDA_DATABASE_USER}
      - CAMUNDA_DATABASE_PASSWORD=${CAMUNDA_DATABASE_PASSWORD}
      - CAMUNDA_SSL_KEYSTORE_PASSWORD=${CAMUNDA_SSL_KEYSTORE_PASSWORD}
      - CAMUNDA_SSL_KEY_PASSWORD=${CAMUNDA_SSL_KEY_PASSWORD}
      - CAMUNDA_LDAP_SERVER_URL=${CAMUNDA_LDAP_SERVER_URL}
    networks:
      - services_network
    depends_on:
      postgresql:
        condition: service_healthy
      openldap:
        condition: service_healthy
    restart: unless-stopped

  # ==================== Основное приложение (NiceGUI) ====================
  app:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: nicegui-app
    ports:
      - "${APP_PORT:-8080}:8080"
    volumes:
      - ../logs:/app/logs
      - ../static:/app/static
    environment:
      # Настройки приложения
      - APP_NAME=${APP_NAME:-NiceGUI Example}
      - DEBUG=${DEBUG:-false}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - PORT=${APP_PORT:-8080}
      - HOST=0.0.0.0
      
      # Настройки Camunda (используем имя сервиса из docker-compose)
      - CAMUNDA_URL=${CAMUNDA_URL:-https://camunda:8443}
      - CAMUNDA_USERNAME=${CAMUNDA_USERNAME}
      - CAMUNDA_PASSWORD=${CAMUNDA_PASSWORD}
      - CAMUNDA_VERIFY_SSL=${CAMUNDA_VERIFY_SSL:-false}
      
      # Настройки LDAP (используем имя сервиса из docker-compose)
      - LDAP_SERVER=${LDAP_SERVER}
      - LDAP_USER=${LDAP_USER}
      - LDAP_PASSWORD=${LDAP_PASSWORD}
      
      # Настройки Mayan (используем имя сервиса из docker-compose)
      - MAYAN_URL=${MAYAN_URL:-http://mayan-app:8000}
      - MAYAN_USERNAME=${MAYAN_USERNAME:-admin}
      - MAYAN_PASSWORD=${MAYAN_PASSWORD:-}
      - MAYAN_API_TOKEN=${MAYAN_API_TOKEN:-}
      - MAYAN_INCOMING_DOCUMENT_TYPE=${MAYAN_INCOMING_DOCUMENT_TYPE:-Входящие}
      - MAYAN_INCOMING_CABINET=${MAYAN_INCOMING_CABINET:-Входящие письма}
      
      # Настройки почтового сервера
      - EMAIL_SERVER=${EMAIL_SERVER:-}
      - EMAIL_PORT=${EMAIL_PORT:-993}
      - EMAIL_USERNAME=${EMAIL_USERNAME:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_USE_SSL=${EMAIL_USE_SSL:-true}
      - EMAIL_PROTOCOL=${EMAIL_PROTOCOL:-imap}
      - EMAIL_ALLOWED_SENDERS=${EMAIL_ALLOWED_SENDERS:-}
      - EMAIL_CHECK_INTERVAL=${EMAIL_CHECK_INTERVAL:-300}
      
      # Настройки логирования
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=/app/logs
      - LOG_FILE=app.log
    networks:
      - services_network
    depends_on:
      postgresql:
        condition: service_healthy
      openldap:
        condition: service_healthy
      mayan-app:
        condition: service_started
      camunda:
        condition: service_started
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
        mode: "non-blocking"

networks:
  services_network:
    driver: bridge


