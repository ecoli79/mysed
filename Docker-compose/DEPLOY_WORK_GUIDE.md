# Руководство по использованию модуля развертывания процессов

## Обзор изменений

Модуль `deploy_work.py` был полностью переработан для корректной работы с Camunda API. Основные исправления:

### 1. Исправлен метод `deploy_process` в `CamundaClient`
- **Проблема**: Неправильный формат multipart/form-data
- **Решение**: Разделение параметров на `data` (текстовые) и `files` (файлы)
- **Результат**: Устранена ошибка 500 при развертывании

### 2. Улучшена обработка ошибок
- Добавлено детальное логирование ошибок
- Показ статуса ответа и текста ошибки
- Улучшенная диагностика проблем

### 3. Добавлены новые функции
- **Тест подключения**: Проверка доступности Camunda сервера
- **Валидация BPMN**: Проверка корректности загружаемых файлов
- **Предварительный просмотр**: Показ названия процесса из BPMN
- **Прогресс-бар**: Визуальная индикация процесса развертывания

## Как использовать

### 1. Тестирование подключения
1. Откройте страницу "Шаблоны процессов"
2. Нажмите кнопку "Тест подключения"
3. Проверьте результат в уведомлениях

### 2. Развертывание BPMN процесса
1. Введите имя развертывания
2. Выберите BPMN файл (поддерживаются .bpmn и .xml)
3. При необходимости настройте дополнительные параметры:
   - Фильтрация дубликатов
   - Развертывание только измененных файлов
   - Tenant ID
4. Нажмите "Развернуть процесс"

### 3. Управление процессами
- Просмотр списка активных процессов
- Информация о версиях и статусах
- Обновление списка

## Технические детали

### Исправления в CamundaClient
```python
# Старый код (неправильный)
files = {
    'deployment-name': (None, deployment_name),
    'data': (filename, content, 'application/xml')
}

# Новый код (правильный)
data = {
    'deployment-name': deployment_name,
    'enable-duplicate-filtering': 'false'
}
files = {
    'data': (filename, content, 'application/xml')
}
```

### Валидация BPMN
```python
def is_valid_bpmn(content):
    content_str = content.decode('utf-8')
    return ('<definitions' in content_str and 
            'xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"' in content_str and
            '<process' in content_str)
```

## Устранение проблем

### Ошибка 500 при развертывании
- **Причина**: Неправильный формат multipart/form-data или проблемы с кодировкой
- **Решение**: Используйте исправленную версию модуля с правильным MIME-типом (text/xml)

### Ошибка "Could not parse BPMN file"
- **Причина**: Проблемы с кодировкой файла или неправильный MIME-тип
- **Решение**: 
  - Модуль автоматически исправляет кодировку (UTF-8, Windows-1251)
  - Используется правильный MIME-тип `text/xml`
  - Добавлена валидация BPMN файлов

### Проблемы с JavaScript в BPMN
- **Причина**: JavaScript скрипты могут не работать в некоторых версиях Camunda
- **Решение**: Используйте подходящую версию BPMN файла:
  - `task_review_doc_final.bpmn` - версия без JavaScript (рекомендуется)
  - `task_review_doc_with_storage.bpmn` - версия с JavaScript для автоматического сохранения дат
  - `test_simple.bpmn` - простой тестовый процесс

## Новые возможности

### Процесс ознакомления с документом
- **Множественные пользователи**: Каждый пользователь может указать свою дату ознакомления
- **Встроенные формы**: Использует формы Camunda для ввода данных
- **Автоматическая инициализация**: Переменные процесса инициализируются автоматически
- **Сохранение данных**: Даты ознакомления сохраняются в переменных процесса
- **Тестирование**: Встроенный интерфейс для тестирования процесса

### Хранение переменных с датами ознакомления

#### Переменные процесса:
- **`reviewDates`** - Словарь с датами ознакомления для каждого пользователя
  - Формат: `{"user1": "2024-01-15", "user2": "2024-01-16"}`
- **`reviewComments`** - Словарь с комментариями для каждого пользователя
  - Формат: `{"user1": "Ознакомился", "user2": "Все понятно"}`
- **`reviewStatus`** - Словарь со статусом ознакомления для каждого пользователя
  - Формат: `{"user1": true, "user2": false}`
- **`completedReviews`** - Количество завершенных ознакомлений (Number)
- **`totalReviews`** - Общее количество пользователей для ознакомления (Number)

#### Как сохраняются данные:
1. **При завершении задачи** пользователем вызывается `complete_document_review_with_storage()`
2. **Данные сохраняются** в переменных процесса в формате JSON
3. **Счетчик обновляется** автоматически
4. **Данные доступны** через `get_document_review_status()`

### Как использовать процесс ознакомления:

#### Вариант 1: Без JavaScript (рекомендуется)
1. Разверните BPMN файл `task_review_doc_final.bpmn`
2. Перейдите на вкладку "Шаблоны"
3. В разделе "Тестирование процесса ознакомления" заполните поля:
   - Название документа
   - Содержимое документа
   - Список пользователей (через запятую)
4. Нажмите "Запустить процесс ознакомления"
5. Для завершения задач используйте `complete_document_review_with_storage()`

#### Вариант 2: С автоматическим сохранением (JavaScript)
1. Разверните BPMN файл `task_review_doc_with_storage.bpmn`
2. Перейдите на вкладку "Шаблоны"
3. В разделе "Тестирование процесса ознакомления" заполните поля
4. Нажмите "Запустить процесс ознакомления"
5. Даты ознакомления сохраняются автоматически при завершении задач

### Ошибки подключения
- Проверьте доступность сервера Camunda
- Убедитесь в корректности учетных данных
- Проверьте настройки SSL

### Проблемы с BPMN файлами
- Убедитесь, что файл является валидным BPMN 2.0
- Проверьте наличие обязательных элементов
- Используйте только поддерживаемые расширения (.bpmn, .xml)

## Логирование

Все операции логируются с помощью стандартного Python logging:
- Уровень INFO: Успешные операции
- Уровень ERROR: Ошибки с детальной информацией
- Уровень DEBUG: Детальная отладочная информация

## Безопасность

- SSL сертификаты отключены для тестирования (verify=False)
- Учетные данные хранятся в коде (рекомендуется вынести в переменные окружения)
- Временные файлы автоматически удаляются после использования
