<?xml version="1.0" encoding="UTF-8"?>
<definitions
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
    xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
    xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                        http://www.omg.org/spec/BPMN/2.0/20100501/BPMN20.xsd
                        http://camunda.org/schema/1.0/bpmn
                        http://camunda.org/schema/1.0/bpmn/camunda-bpmn.xsd"
    id="Definitions_1"
    targetNamespace="http://bpmn.io/schema/bpmn"
    exporter="bpmn-io" exporterVersion="17.0.0">

  <!-- Альтернативный процесс ознакомления с документом для нескольких пользователей -->
  <process 
      id="DocumentReviewProcessAlternative" 
      name="Ознакомиться с документом (Альтернативный)" 
      isExecutable="true"
      camunda:historyTimeToLive="30">

    <documentation>
      <![CDATA[
      Альтернативный процесс ознакомления с документом для нескольких пользователей.
      Использует обычные задачи вместо Multi-Instance для более надежного контроля.
      ]]>
    </documentation>

    <!-- Стартовое событие -->
    <startEvent id="StartEvent_1" name="Начало ознакомления" />
    
    <!-- Пользовательская задача ознакомления -->
    <userTask 
        id="reviewTask" 
        name="Ознакомиться с документом">
      
      <documentation>
        Задача ознакомления: пользователь должен ознакомиться с документом
      </documentation>
      
      <extensionElements>
        <camunda:formData>
          <camunda:formField id="reviewed" label="Ознакомлен" type="boolean" defaultValue="false">
            <camunda:validation>
              <camunda:constraint name="required" />
            </camunda:validation>
          </camunda:formField>
          <camunda:formField id="reviewDate" label="Дата ознакомления" type="date" />
          <camunda:formField id="reviewComment" label="Комментарий" type="string" />
        </camunda:formData>
        
        <!-- Task Listener для обработки завершения задачи -->
        <camunda:taskListener event="complete" 
          class="org.camunda.bpm.engine.delegate.TaskListener">
          <camunda:script scriptFormat="javascript">
            // Получаем данные из переменных процесса
            var currentUser = task.getAssignee();
            var reviewDate = execution.getVariable("reviewDate");
            var reviewComment = execution.getVariable("reviewComment");
            var reviewed = execution.getVariable("reviewed");
            
            // Логируем для отладки
            print("=== Task Listener Debug ===");
            print("currentUser: " + currentUser);
            print("reviewDate: " + reviewDate);
            print("reviewComment: " + reviewComment);
            print("reviewed: " + reviewed);
            print("reviewed type: " + typeof reviewed);
            
            // Инициализируем словари для хранения данных
            var reviewDates = execution.getVariable("reviewDates") || {};
            var reviewComments = execution.getVariable("reviewComments") || {};
            var reviewStatus = execution.getVariable("reviewStatus") || {};
            var userCompleted = execution.getVariable("userCompleted") || {};
            
            // Получаем текущий счетчик
            var completedReviews = execution.getVariable("completedReviews") || 0;
            print("Текущий счетчик completedReviews: " + completedReviews);
            
            // Сохраняем данные для текущего пользователя
            if (reviewed) {
              print("Условие reviewed == true выполнено");
              
              reviewDates[currentUser] = reviewDate;
              reviewComments[currentUser] = reviewComment;
              reviewStatus[currentUser] = true;
              userCompleted[currentUser] = true;
              
              // Увеличиваем счетчик завершенных ознакомлений
              completedReviews = completedReviews + 1;
              
              // Обновляем переменные процесса
              execution.setVariable("reviewDates", reviewDates);
              execution.setVariable("reviewComments", reviewComments);
              execution.setVariable("reviewStatus", reviewStatus);
              execution.setVariable("userCompleted", userCompleted);
              execution.setVariable("completedReviews", completedReviews);
              
              // Логируем информацию
              print("Пользователь " + currentUser + " ознакомился с документом " + reviewDate);
              print("Новый счетчик completedReviews: " + completedReviews);
              
              // Получаем общее количество пользователей
              var assigneeList = execution.getVariable("assigneeList");
              var totalUsers = assigneeList ? assigneeList.size() : 0;
              print("Всего пользователей: " + totalUsers + ", завершено: " + completedReviews);
            } else {
              print("Пользователь " + currentUser + " НЕ ознакомился с документом (reviewed = " + reviewed + ")");
            }
            print("=== End Task Listener Debug ===");
          </camunda:script>
        </camunda:taskListener>
      </extensionElements>
      
    </userTask>

    <!-- Шлюз для проверки завершения всех ознакомлений -->
    <exclusiveGateway id="checkCompletion" name="Проверить завершение" />
    
    <!-- Конечное событие -->
    <endEvent id="EndEvent_1" name="Ознакомление завершено" />

    <!-- Потоки выполнения -->
    <sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="reviewTask" />
    <sequenceFlow id="Flow_2" sourceRef="reviewTask" targetRef="checkCompletion" />
    <sequenceFlow id="Flow_3" sourceRef="checkCompletion" targetRef="EndEvent_1">
      <conditionExpression xsi:type="tFormalExpression">
        ${completedReviews >= assigneeList.size()}
      </conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="Flow_4" sourceRef="checkCompletion" targetRef="reviewTask">
      <conditionExpression xsi:type="tFormalExpression">
        ${completedReviews < assigneeList.size()}
      </conditionExpression>
    </sequenceFlow>

  </process>

  <!-- Диаграмма -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="DocumentReviewProcessAlternative">
      
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <omgdc:Bounds x="179" y="109" width="36" height="36" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="UserTask_1_di" bpmnElement="reviewTask">
        <omgdc:Bounds x="250" y="90" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="Gateway_1_di" bpmnElement="checkCompletion">
        <omgdc:Bounds x="400" y="105" width="50" height="50" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <omgdc:Bounds x="500" y="109" width="36" height="36" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <omgdi:waypoint x="215" y="127" />
        <omgdi:waypoint x="250" y="130" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <omgdi:waypoint x="350" y="130" />
        <omgdi:waypoint x="400" y="130" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <omgdi:waypoint x="450" y="130" />
        <omgdi:waypoint x="500" y="127" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_4_di" bpmnElement="Flow_4">
        <omgdi:waypoint x="425" y="105" />
        <omgdi:waypoint x="425" y="50" />
        <omgdi:waypoint x="300" y="50" />
        <omgdi:waypoint x="300" y="90" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</definitions>
