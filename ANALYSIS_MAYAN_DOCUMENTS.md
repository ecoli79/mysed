# –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ mayan_documents.py

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º–µ—Ä—Ç–≤—ã–π –∫–æ–¥)

#### –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **`show_document_content()`** (—Å—Ç—Ä–æ–∫–∏ 1596-1636)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥–µ
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ UI

- **`preview_document_file()`** (—Å—Ç—Ä–æ–∫–∏ 2109-2247)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥–µ
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ UI

- **`grant_access_to_document()`** (—Å—Ç—Ä–æ–∫–∏ 1567-1594)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `show_grant_access_dialog()`
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å

- **`grant_access_to_document_enhanced()`** (—Å—Ç—Ä–æ–∫–∏ 2294-2331)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å

- **`show_document_access_info()`** (—Å—Ç—Ä–æ–∫–∏ 2334-2407)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–µ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ UI

- **`temp_file_for_download()`** (—Å—Ç—Ä–æ–∫–∏ 193-226)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
  - –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `safe_download_file()`
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å

- **`reset_mayan_client_cache()`** (—Å—Ç—Ä–æ–∫–∏ 976-980)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ logout

#### –†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **`clear_metadata_cache()`** (—Å—Ç—Ä–æ–∫–∏ 391-405)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 2. –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

- **–°—Ç—Ä–æ–∫–∏ 2249-2292:** –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è `grant_access_to_document_enhanced`
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å

- **–°—Ç—Ä–æ–∫–∞ 1329:** –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `show_grant_access_dialog`
  ```python
  # ui.button('–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø', icon='share', color='blue').classes('text-xs px-2 py-1 h-7').on_click(
  #     lambda doc=document: show_grant_access_dialog(doc)
  # )
  ```
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω—É–∂–Ω–∞

### 3. –°—Ç–∞—Ä—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

- **–°—Ç—Ä–æ–∫–∏ 90-100:** –°—Ç–∞—Ä—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è "–æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"
  - `_recent_documents_container`, `_search_results_container`, `_upload_form_container`, `_favorites_container`
  - `_mayan_client`, `_mayan_client_cache`, `_token_checked`
  - `_connection_status`, `_auth_error`, `_current_user`
  - **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `check_connection()` –∏ `theme.py` (`_current_user`)
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
    - –ó–∞–º–µ–Ω–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `check_connection()` –Ω–∞ `state`
    - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `_current_user` –¥–ª—è `theme.py` (–∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é)

### 4. –û—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ

- **`show_document_content()` (—Å—Ç—Ä–æ–∫–∞ 1601):**
  ```python
  client = get_mayan_client()  # ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ async —Ñ—É–Ω–∫—Ü–∏–∏
  ```
  - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `client = await get_mayan_client()`
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

## üü° –ü—Ä–æ–±–ª–µ–º—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è MIME-—Ç–∏–ø–∞

**–ú–µ—Å—Ç–æ 1:** `preview_document_file()` (—Å—Ç—Ä–æ–∫–∏ 2124-2145)
```python
if file_content[:4] == b'%PDF':
    mimetype = 'application/pdf'
elif file_content[:3] == b'\xff\xd8\xff':
    mimetype = 'image/jpeg'
# ... –∏ —Ç.–¥.
```

**–ú–µ—Å—Ç–æ 2:** `update_preview_in_card()` (—Å—Ç—Ä–æ–∫–∏ 1079-1083)
```python
mimetype = 'image/jpeg'
if image_data[:4] == b'\x89PNG':
    mimetype = 'image/png'
elif image_data[:6] in [b'GIF87a', b'GIF89a']:
    mimetype = 'image/gif'
```

**–ú–µ—Å—Ç–æ 3:** `load_preview()` –≤–Ω—É—Ç—Ä–∏ `create_document_card()` (—Å—Ç—Ä–æ–∫–∏ 1223-1227)
```python
mimetype = 'image/jpeg'
if image_data[:4] == b'\x89PNG':
    mimetype = 'image/png'
elif image_data[:6] in [b'GIF87a', b'GIF89a']:
    mimetype = 'image/gif'
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `detect_mimetype_from_bytes(content: bytes, filename: str = None) -> str`

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é

**–ú–µ—Å—Ç–æ 1:** `load_preview()` –≤–Ω—É—Ç—Ä–∏ `create_document_card()` (—Å—Ç—Ä–æ–∫–∏ 1193-1280)
**–ú–µ—Å—Ç–æ 2:** `update_preview_in_card()` (—Å—Ç—Ä–æ–∫–∏ 1065-1116)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `update_preview_in_card()` –≤–µ–∑–¥–µ

### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –±–ª–æ–∫–∏ try-except —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π –≤:
- `load_recent_documents()`
- `search_documents()`
- `load_documents_by_cabinets()`
- `load_favorite_documents()`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:** 3218
- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:** 7
- **–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫:** ~45
- **–°—Ç–∞—Ä—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:** 10
- **–î—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞:** 3 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—á–∏—Å—Ç–∫–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
   - `show_document_content()`
   - `preview_document_file()`
   - `grant_access_to_document()`
   - `grant_access_to_document_enhanced()`
   - `show_document_access_info()`
   - `temp_file_for_download()`

2. –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 2249-2292, 1329)

3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `check_connection()`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–≤–∞–∂–Ω–æ):
1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
   - –°–æ–∑–¥–∞—Ç—å `detect_mimetype_from_bytes()`
   - –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é
   - –°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

2. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∫—Ä–æ–º–µ `_current_user` –¥–ª—è `theme.py`)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
1. –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `clear_metadata_cache()` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `reset_mayan_client_cache()` –ø—Ä–∏ logout

## üéØ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è

–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:
- **–£–¥–∞–ª–µ–Ω–∏–µ:** ~500-600 —Å—Ç—Ä–æ–∫ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞
- **–£–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏:** –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:** –£–ø—Ä–æ—â–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–¥–∞

